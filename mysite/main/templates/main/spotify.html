{% extends 'main/base.html' %}

{% block title %} Currently Playing {% endblock %}

{% block content %}
    <br>
    {% if album_art %}<img src="{{album_art}}" alt="home" class="album_art" id="al_art">{% endif %}
    <h2>{{track}}</h2>
    <h6>{{artist}}</h6>
    <div>
        <button id="play-button"></button>
    </div>
    {% if key %}
    <br>
    <details open class="definition-field">
        <summary class="definition-title">Reveal/Hide Key</summary>
        <h4>{{key}} {{mode}}</h4>
        {% if key_confidence %}<h6>{{key_confidence}}%</h6>{% endif %}
    </details>
    {% endif %}
    <span id="test"></span>
    <br><br>

    <a href="https://tunebat.com/Search?q={{first_artist}}+{{track_name_for_searching}}">tunebat</a><br>
    <a href="https://www.notediscover.com/search?q={{first_artist}}+{{track_name_for_searching}}">notediscover</a><br>
    <a href="https://chordify.net/search/{{first_artist}}+{{track_name_for_searching}}">chordify(requires login)</a><br>
    <a href="https://www.ultimate-guitar.com/search.php?search_type=title&value={{first_artist}}+{{track_name_for_searching}}">ultimate guitar</a>

    {% load static %}
    <img src="{% static "main/media/circle_5.jpg" %}" alt="home" class="fifths"/>

{% endblock %}

{% block scripts %}
<script>
    var songTitle = document.getElementById("test");
    var playButton = document.getElementById("play-button");

    var lastPlayedSong = ''
    var ctr = 0;

    var pauseInterval = 5000;
    var progressMS;
    var durationMS;

    var playState = null;

    function isSomethingPlayingOrNot() {
        // console.log('hello') - works
       $.ajax({
            type:'GET',
            url: 'http://127.0.0.1:8000/ajax_spotify_track_info/',
            success: function (data) {
                // console.log(data['is_playing']);
                // console.log(data['is_playing']);
                // alert(`play state: ${data['is_playing']}`);
                playState = data['is_playing'];
                if (data['is_playing'] == null || data['is_playing'] == false) {
                    playButton.innerHTML = 'Play';
                } else {
                    playButton.innerHTML = 'Pause';
                }
            },
            error: function (data) {
                // this probably means something is already playing, that's why we get
                // spotipy.exceptions.SpotifyException: http status: 403, code:-1
                // Player command failed: Restriction violated, reason: UNKNOWN
                // console.log('error')
                alert(`ERROR, play state: ${data['is_playing']}`);
                playButton.innerHTML = 'Pause';
            }
        })
    };
    // playButton.addEventListener('load', isSomethingPlayingOrNot)
    isSomethingPlayingOrNot();

    playButton.addEventListener('click', z)
        // what happens if I click the button
        // if button is paused, only check play status after 100s
    function z() {
        if (playButton.innerHTML == 'Play') {
            playButton.innerHTML = 'Pause';
            spotifyPauseOrPlay({'status_to_send_to_sp': 'play'});
        }
        else {
            playButton.innerHTML = 'Play';
            spotifyPauseOrPlay({'status_to_send_to_sp': 'pause'});
        }
    };

    function spotifyPauseOrPlay(requestBody) {
        // console.log(`request body: ${JSON.stringify(requestBody)}`)
        $.ajax({
            type:'GET',
            url: 'http://127.0.0.1:8000/ajax_pause_play/',
            data: requestBody,
            dataType: 'json'
        })
    };




    // TODO: JS pause play button, its functionality must actually pause and play the track
    // button must update text
    // would also pause/play the constantly running/sleeping function whenever clicked

    // also check: only update state if the current track has actually changed

    // TODO: include a refresh status button,
    // because i'd set the function to actually stop running ,if after it sent 5 requests
    // it received pause or nothing, then stop, only refresh
    // ORRR try this: check what happens if you PUT request Start/resume playback if something is already playing
    // will it simply continue? if then, then that's ok

    // function timeout() {
    // var interval = setInterval(function () {
    //     // ctr++;
    //     fetch('http://127.0.0.1:8000/ajax_spotify_track_info')
    //         .then(function (response) {
    //             return response.json();
    //         })
    //         .then(function (data) {
    //             songTitle.innerHTML = data['track'];
    //             progressMS = data['progress_ms'];
    //             durationMS = data['duration_ms'];
    //             pauseInterval = durationMS - progressMS;
    //             // console.log(pauseInterval)
    //             if (pauseInterval > 100000) {
    //                 pauseInterval = 100000;
    //             }
    //         })
    //         .catch(function (data) {
    //             console.log('BOO ERROR IDK', data);
    //         })
    //     pauseInterval = durationMS - progressMS;
    //     console.log(pauseInterval)
    // }, pauseInterval);
    // };

    // timeout();

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

</script>

{% endblock %}