{% extends 'main/base.html' %}

{% block title %} Currently Playing {% endblock %}

{% block content %}
    <br>
    {% if album_art %}<img src="{{album_art}}" alt="home" class="album_art" id="al_art">{% endif %}
    <h2 id="track-title">{{track}}</h2>
    <h6 id="artist-name">{{artist}}</h6>
    <div>
        <button id="play-button"></button>
    </div>
    {% if key %}
    <br>
    <details open class="definition-field">
        <summary class="definition-title">Reveal/Hide Key</summary>
        <h4 id="key-signature">{{key}}</h4> <h4 id="music-mode">{{mode}}</h4>
        {% if key_confidence %}<h6 id="key-confidence">{{key_confidence}}%</h6>{% endif %}
    </details>
    {% endif %}
    <span id="test"></span>
    <br><br>

    <a href="https://tunebat.com/Search?q={{first_artist}}+{{track_name_for_searching}}">tunebat</a><br>
    <a href="https://www.notediscover.com/search?q={{first_artist}}+{{track_name_for_searching}}">notediscover</a><br>
    <a href="https://chordify.net/search/{{first_artist}}+{{track_name_for_searching}}">chordify(requires login)</a><br>
    <a href="https://www.ultimate-guitar.com/search.php?search_type=title&value={{first_artist}}+{{track_name_for_searching}}">ultimate guitar</a>

    {% load static %}
    <img src="{% static "main/media/circle_5.jpg" %}" alt="home" class="fifths"/>

{% endblock %}

{% block scripts %}
<script>
    var testSongTitle = document.getElementById("test");

    var mainSongTitle = document.getElementById('track-title');
    var artistName = document.getElementById('artist-name');
    var albumArt = document.getElementById('al_art');
    var keySignature = document.getElementById('key-signature');
    var keyConfidence = document.getElementById('key-confidence');
    var musicMode = document.getElementById('music-mode');

    var playButton = document.getElementById("play-button");


    function isSomethingPlayingOrNot() {
       $.ajax({
            type:'GET',
            url: 'http://127.0.0.1:8000/ajax_spotify_track_info/',
            success: function (data) {
                playState = data['is_playing'];
                if (data['is_playing'] == null || data['is_playing'] == false) {
                    playButton.innerHTML = 'Play';
                } else {
                    playButton.innerHTML = 'Pause';
                }
            },
            error: function (data) {
                // this probably means something is already playing, that's why we get
                // spotipy.exceptions.SpotifyException: http status: 403, code:-1
                // Player command failed: Restriction violated, reason: UNKNOWN
                // console.log('error')
                alert(`ERROR, play state: ${data['is_playing']}`);
                playButton.innerHTML = 'Pause';
            }
        })
    };
    isSomethingPlayingOrNot();

    function playingOrNot2 () {
        return  fetch('http://127.0.0.1:8000/ajax_spotify_track_info')
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                // console.log(`data: ${data}`)
                var curTrack = data['track'].toString();
                var prevTrack = mainSongTitle.innerHTML.toString();
                if (curTrack !== prevTrack) {
                    testSongTitle.innerHTML = curTrack;
                    mainSongTitle.innerHTML = curTrack;
                    artistName.innerHTML = data['artist'];
                    keySignature.innerHTML = data['key'];
                    keyConfidence.innerHTML = data['key_confidence'];
                    musicMode.innerHTML = data['mode'];
                    albumArt.setAttribute('src', data['album_art']);
                }
            })
            .catch(function (data) {
                console.log('playingOrNot2 ERROR IDK', data);
            })
    };

    // TODO: a button to stop/restart the infinite loop
    async function infiniteLoop() {
        while (true) {
            await playingOrNot2()
                .then(data => {
                    // curSong = data['track'];
                })
                .catch(function (data) {
                    console.log('error from playingOrNot2 function call');
                });
            await sleep(13000);
            console.log('sleeping zzzz')
        }
    };
    infiniteLoop();


    playButton.addEventListener('click', z)
    function z() {
        if (playButton.innerHTML == 'Play') {
            playButton.innerHTML = 'Pause';
            spotifyPauseOrPlay({'status_to_send_to_sp': 'play'});
        }
        else {
            playButton.innerHTML = 'Play';
            spotifyPauseOrPlay({'status_to_send_to_sp': 'pause'});
        }
    };

    function spotifyPauseOrPlay(requestBody) {
        $.ajax({
            type:'GET',
            url: 'http://127.0.0.1:8000/ajax_pause_play/',
            data: requestBody,
            dataType: 'json'
        })
    };

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

</script>

{% endblock %}